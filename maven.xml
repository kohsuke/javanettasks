<project xmlns:j="jelly:core" xmlns:u="jelly:util">
  
  <!-- define a tag that generates -->
  <define:taglib uri="manifest-builder" xmlns:define="jelly:define">
    <define:tag name="build-dep-manifest">
      <j:set var="classpath" value=""/>
      <j:forEach var="dep" items="${pom.dependencies}">
        <j:set var="classpath" value="${classpath} lib/${dep.artifact}"/>
      </j:forEach>
      
      <!-- check if the user specified manifest file is available -->
      <available property="maven.jar.manifest.available2" file="${maven.jar.manifest}"/>
      <j:if test="${maven.jar.manifest.available2}">
        <j:set var="maven.jar.manifest" value="${maven.build.dir}/MANIFEST.MF"/>
        <property name="maven.jar.manifest" value="${maven.jar.manifest}"/>
      </j:if>
      
      <manifest file="${maven.jar.manifest}" mode="update">
        <attribute name="Class-Path" value="${classpath}"/>
        <attribute name="Main-Class" value="org.kohsuke.jnt.tools.Main"/>
      </manifest>
    </define:tag>
  </define:taglib>
  
  
  
  
  <postGoal name="dist:prepare-bin-filesystem">
    <!-- copy additional files into the distribution zip/tgz -->
    <deploy:copy-deps xmlns:deploy="deploy"
      todir="${maven.dist.bin.archive.dir}/${maven.final.name}/lib"
    />
    <copy todir="${maven.dist.bin.archive.dir}/${maven.final.name}"
      file="target/${pom.artifactId}-jdk1.2-${pom.currentVersion}.jar" />
  </postGoal>
  
  <preGoal name="jar:jar">
    <build-dep-manifest xmlns="manifest-builder" />
  </preGoal>
  
  <postGoal name="jar:jar">
    <!-- build 1.2 jar -->
		<delete dir="target/classes12"/>
		<mkdir dir="target/classes12"/>
    <unjar src="target/${pom.artifactId}-${pom.currentVersion}.jar" dest="target/classes12"/>
		
		<java classname="com.rc.retroweaver.Weaver" fork="true">
			<arg line="-version 1.2" />
			<arg value="-source"/>
			<arg path="target/classes12"/>
			<classpath>
				<fileset dir="lib/retroweaver">
					<include name="*.jar"/>
				</fileset>
			</classpath>
		</java>

    <mkdir dir="target/retroweaver"/>
    <unjar src="lib/retroweaver/retroweaver.jar" dest="target/retroweaver"/>

		<jar jarfile="target/${pom.artifactId}-jdk1.2-${pom.currentVersion}.jar" compress="true"
			manifest="target/classes12/META-INF/MANIFEST.MF">
      <!-- bundle the retroweaver runtime -->
      <fileset dir="target/retroweaver" includes="**/runtime/*.class"/>
			<fileset dir="target/classes12" includes="**/*" />
		</jar>
	</postGoal>
  
  <goal name="release">
    <attainGoal name="dist" />
    
    <taskdef resource="org/kohsuke/javanettasks.properties">
      <classpath>
        <pathelement path="target/classes" />
        <fileset dir="${maven.dist.bin.archive.dir}/${maven.final.name}/lib" includes="**/*.jar" />
      </classpath>
    </taskdef>
    
    <javaNetUpload
      projectName="javanettasks"
      overwrite="yes"
      toFile="/releases/${pom.artifactId}-${pom.currentVersion}.zip"
      fromFile="target/distributions/${pom.artifactId}-${pom.currentVersion}.zip"
      fileStatus="Stable"
    />
  </goal>
</project>
